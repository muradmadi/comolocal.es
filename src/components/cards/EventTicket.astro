---
import { Badge } from "@/components/ui/Badge";
import { Button } from "@/components/ui/Button";
import type { Event } from "@/types/wordpress";

interface Props {
  event: Event;
}

const { event } = Astro.props;

// Safe data access
const image = event.featuredImage?.node?.sourceUrl;
const alt = event.featuredImage?.node?.altText || event.title;
const venue = event.eventData?.relatedVenue?.nodes?.[0];
const venueName = venue?.title || "Unknown Venue";

// Date formatting
function formatDate(dateString: string) {
    const date = new Date(dateString);
    return {
        day: date.getDate(),
        month: date.toLocaleDateString('en-US', { month: 'short' }),
        weekday: date.toLocaleDateString('en-US', { weekday: 'short' }),
        fullDate: date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }),
        time: date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
    };
}

const startDate = event.eventData?.eventStart ? formatDate(event.eventData.eventStart) : null;
const ticketUrl = event.eventData?.ticketUrl || (venue ? `/venues/${venue.slug}/` : '#');
---

<div class="group relative flex flex-col md:flex-row w-full bg-card border border-border/50 rounded-xl overflow-hidden hover:shadow-lg transition-all duration-300 hover:border-primary/50">
    
    <!-- Left: Image Section -->
    <!-- Left: Image Section -->
    <div class="relative w-full md:w-1/3 lg:w-1/4 h-48 md:h-auto overflow-hidden bg-muted flex items-center p-6">
        {image ? (
            <img 
                src={image} 
                alt={alt} 
                class="w-full h-full object-contain object-left transition-transform duration-500"
            />
        ) : (
            <div class="w-full h-full flex items-center justify-center">
                 <span class="text-4xl">ðŸŽ‰</span>
            </div>
        )}
        
        {/* Mobile Date Badge */}
        <div class="absolute top-3 left-3 md:hidden">
            <Badge variant="secondary" className="backdrop-blur-sm bg-background/80 shadow-sm">
                {startDate ? `${startDate.month} ${startDate.day}` : 'Upcoming'}
            </Badge>
        </div>
    </div>

    <!-- Middle: Info Section -->
    <div class="flex-1 p-5 md:pl-8 md:pr-6 md:py-6 flex flex-col justify-between relative bg-card">
         {/* Perforation holes decoration for desktop */}
        <div class="hidden md:block absolute -left-3 top-[-10px] bottom-[-10px] w-6 bg-[radial-gradient(circle,transparent_60%,hsl(var(--background))_60%)] bg-[length:20px_20px] bg-left-repeat-y z-10 pointer-events-none"></div>

        <div class="space-y-3">
            <div class="flex items-start justify-between gap-4">
                <div class="space-y-1">
                    <h3 class="text-xl md:text-2xl font-bold leading-tight group-hover:text-primary transition-colors">
                        <a href={`/events/${event.slug}/`} class="focus:outline-none">
                            <span class="absolute inset-0 md:hidden"></span>
                            {event.title}
                        </a>
                    </h3>
                     <div class="flex items-center text-muted-foreground text-sm font-medium">
                        <span class="text-primary mr-1">@</span> 
                        {venue ? (
                            <a href={`/venues/${venue.slug}/`} class="text-foreground hover:text-primary hover:underline underline-offset-4 decoration-2 transition-colors">
                                {venueName}
                            </a>
                        ) : (
                            <span>{venueName}</span>
                        )}
                    </div>
                </div>
            </div>

            <p class="text-muted-foreground text-sm line-clamp-2 md:line-clamp-2">
                 {event.content?.replace(/(<([^>]+)>)/gi, "") || ''}
            </p>
        </div>

        <div class="mt-4 pt-4 border-t border-dashed border-border/50 flex flex-wrap gap-4 text-sm text-foreground/80">
            {startDate && (
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                    <span>{startDate.fullDate}</span>
                </div>
            )}
            {startDate && (
                <div class="flex items-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span>{startDate.time}</span>
                </div>
            )}
        </div>
    </div>

    <!-- Right: Ticket Stub / Action -->
    <div class="relative w-full md:w-48 bg-muted/30 border-t md:border-t-0 md:border-l border-dashed border-border flex flex-row md:flex-col items-center justify-between md:justify-center p-4 gap-4">
        {/* Cutout notches */}
        <div class="absolute -left-3 top-[-10px] w-6 h-6 rounded-full bg-background hidden md:block shadow-inner"></div>
        <div class="absolute -left-3 bottom-[-10px] w-6 h-6 rounded-full bg-background hidden md:block shadow-inner"></div>
        
        {startDate && (
            <div class="text-center hidden md:block">
                <span class="block text-3xl font-black text-primary">{startDate.day}</span>
                <span class="block text-sm font-bold uppercase tracking-wider text-muted-foreground">{startDate.month}</span>
            </div>
        )}

        <div class="w-full md:w-auto">
            <a href={ticketUrl} class="w-full">
                <Button size="lg" className="w-full shadow-md group-hover:shadow-primary/25 transition-all">
                    Get Tickets
                </Button>
            </a>
        </div>
    </div>
</div>
