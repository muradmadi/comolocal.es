---
import Layout from '@/layouts/Layout.astro';
import Navbar from '@/components/layout/Navbar';
import VenueCard from '@/components/cards/VenueCard.astro';
import { Badge } from '@/components/ui/Badge';
import { getPostBySlug } from '@/lib/api/wordpress';
import type { Venue } from '@/types/wordpress';

export const prerender = false; // Ensure SSR

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

// 1. SANITIZE: Remove any accidental slashes from the param
const cleanSlug = slug.replace(/^\/|\/$/g, '');
const post = await getPostBySlug(cleanSlug);

// 4. CHECK: If null, 404
if (!post) {
  console.error(`[404 DEBUG] Failed to find post with slug: '${cleanSlug}'`);
  return new Response(null, {
    status: 404,
    statusText: 'Not Found'
  });
}

// Using empty array since we disabled the field in API to solve the 500 error
const mentionedVenues = []; 
const date = new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
---

<Layout title={`${post.title} | Comolocal Guide`}>
  <Navbar client:load />

  <main class="container mx-auto px-4 py-8 md:py-12">
    <article class="max-w-4xl mx-auto">
        {/* Header */}
        <header class="mb-10 md:mb-14 text-center max-w-3xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-700">
            <div class="flex items-center justify-center gap-3 mb-6">
                <a href="/blog/" class="hover:opacity-80 transition-opacity">
                    <Badge variant="outline" className="uppercase tracking-widest text-[10px] px-3 py-1 bg-background/50 backdrop-blur-sm border-primary/20 text-primary">
                        Nightlife Guide
                    </Badge>
                </a>
                <span class="w-1 h-1 rounded-full bg-border"></span>
                <span class="text-sm text-muted-foreground font-medium">{date}</span>
                {post.readTime && (
                    <>
                        <span class="w-1 h-1 rounded-full bg-border"></span>
                        <span class="text-sm text-muted-foreground">{post.readTime} min read</span>
                    </>
                )}
            </div>
            
            <h1 class="text-4xl md:text-6xl font-black tracking-tight leading-[1.1] mb-6 text-foreground drop-shadow-sm">
                {post.title}
            </h1>

            {/* Optional: Add Excerpt/Subtitle here if available in the future */}
        </header>

        {/* Featured Image */}
        {post.featuredImage && (
            <div class="relative w-full aspect-video md:aspect-[21/9] mb-16 overflow-hidden rounded-3xl border border-white/10 shadow-2xl bg-card animate-in fade-in zoom-in-95 duration-1000 delay-200">
                <div class="absolute inset-0 bg-gradient-to-t from-background/20 to-transparent z-10 pointer-events-none"></div>
                <img 
                    src={post.featuredImage.node.sourceUrl} 
                    alt={post.featuredImage.node.altText || post.title}
                    class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 hover:scale-105"
                />
            </div>
        )}

        {/* Content */}
        <div 
            class="prose prose-zinc dark:prose-invert prose-lg md:prose-xl max-w-3xl mx-auto mb-20 animate-in fade-in slide-in-from-bottom-8 duration-700 delay-300
            
            prose-headings:font-bold prose-headings:tracking-tight prose-headings:text-foreground
            prose-h1:text-4xl prose-h1:mb-8
            prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6 prose-h2:text-foreground prose-h2:border-b prose-h2:border-border/30 prose-h2:pb-4
            prose-h3:text-2xl prose-h3:mt-8 prose-h3:mb-4 prose-h3:text-foreground
            
            prose-p:text-muted-foreground prose-p:leading-relaxed prose-p:mb-6
            prose-strong:text-foreground prose-strong:font-semibold
            
            prose-a:text-primary prose-a:font-medium prose-a:no-underline prose-a:transition-colors hover:prose-a:text-accent hover:prose-a:underline
            
            prose-blockquote:border-l-4 prose-blockquote:border-primary/50 prose-blockquote:bg-card/30 prose-blockquote:px-6 prose-blockquote:py-4 prose-blockquote:rounded-r-xl prose-blockquote:not-italic prose-blockquote:text-foreground/90
            
            prose-ul:my-6 prose-li:marker:text-primary prose-li:pl-2
            prose-img:rounded-2xl prose-img:shadow-xl prose-img:border prose-img:border-white/5 prose-img:my-8
            
            prose-hr:border-border/50 prose-hr:my-12"
            set:html={post.content} 
        />

        {/* Smart Listicle Feature: "Mentioned in this Guide" */}
        {mentionedVenues.length > 0 && (
            <section class="border-t border-border pt-12 mt-12">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold tracking-tight mb-2">Mentioned in this Guide</h2>
                    <p class="text-muted-foreground">Check out the venues we talked about.</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {mentionedVenues.map((venue: Venue) => (
                        <VenueCard venue={venue} />
                    ))}
                </div>
            </section>
        )}
    </article>
  </main>
</Layout>
