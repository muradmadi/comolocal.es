---
import Layout from '@/layouts/Layout.astro';
import Navbar from '@/components/layout/Navbar';
import PageHeader from '@/components/layout/PageHeader';
import { getAllPosts } from '@/lib/api/wordpress';
import { ArrowUpRight, Calendar, Tag } from 'lucide-react';

const allPosts = await getAllPosts();

// Optional: Highlight the first post as "Featured"
const featuredPost = allPosts.length > 0 ? allPosts[0] : null;
const remainingPosts = allPosts.length > 1 ? allPosts.slice(1) : [];

function formatDate(dateString: string) {
    return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}
---

<Layout title="Blog | Comolocal">
	<Navbar client:load />
	<PageHeader 
		client:load
		variant="blog"
		title="The ComoLocal Blog"
		accentText="Madrid Nightlife Guides"
	>
		<span slot="subtitle">Stories, tips, and articles that will teach you how to party <span class="text-primary">Como</span> un <span class="text-primary">Local</span></span>
	</PageHeader>
	
	<main class="flex-1 py-12 md:py-20 bg-background">
        <div class="container mx-auto px-4 max-w-6xl">

            {allPosts.length === 0 && (
                <div class="text-center p-20 bg-muted/20 rounded-3xl border border-dashed border-border/50 animate-in fade-in zoom-in duration-500">
                    <div class="w-16 h-16 bg-primary/10 text-primary rounded-full flex items-center justify-center mx-auto mb-6">
                        <Calendar className="w-8 h-8" />
                    </div>
                    <h3 class="text-2xl font-bold mb-2">No stories yet</h3>
                    <p class="text-muted-foreground text-lg max-w-md mx-auto">
                        We're currently scouting the best spots in Madrid. Check back soon for fresh content.
                    </p>
                </div>
            )}

            {featuredPost && (
                <section class="mb-24">
                    <div class="flex items-center gap-4 mb-8">
                       <span class="h-px w-12 bg-primary"></span>
                       <h2 class="text-sm font-bold uppercase tracking-widest text-primary">Featured Story</h2>
                    </div>

                    <a href={`/blog/${featuredPost.slug}/`} class="group relative block w-full aspect-[21/9] md:aspect-[2.4/1] overflow-hidden rounded-3xl">
                        {featuredPost.featuredImage?.node?.sourceUrl ? (
                            <img 
                                src={featuredPost.featuredImage.node.sourceUrl} 
                                alt={featuredPost.featuredImage.node.altText || featuredPost.title} 
                                class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" 
                            />
                        ) : (
                             <div class="w-full h-full bg-muted flex items-center justify-center text-muted-foreground">
                                No Image
                             </div>
                        )}
                        
                        {/* Gradient Overlay */}
                        <div class="absolute inset-0 bg-gradient-to-t from-background/90 via-background/40 to-transparent"></div>

                        {/* Content */}
                        <div class="absolute bottom-0 left-0 p-8 md:p-12 max-w-4xl">
                            <div class="flex items-center gap-4 text-sm font-medium text-primary-foreground/80 mb-4">
                                <span class="bg-primary px-3 py-1 rounded-full text-white">
                                    {featuredPost.categories?.nodes?.[0]?.name || 'Guide'}
                                </span>
                                <span>{formatDate(featuredPost.date)}</span>
                            </div>
                            <h2 class="text-3xl md:text-5xl font-bold text-white mb-4 leading-tight group-hover:text-primary transition-colors">
                                {featuredPost.title}
                            </h2>
                            <div class="text-lg md:text-xl text-white/80 line-clamp-2 max-w-2xl" set:html={featuredPost.excerpt} />
                        </div>
                    </a>
                </section>
            )}

            {remainingPosts.length > 0 && (
                <section class="space-y-16">
                    <div class="flex items-center gap-4 mb-12">
                       <span class="h-px w-12 bg-muted-foreground/30"></span>
                       <h2 class="text-sm font-bold uppercase tracking-widest text-muted-foreground">Latest Stories</h2>
                    </div>

                    <div class="space-y-12">
                        {remainingPosts.map((post: any) => (
                            <article class="group relative grid grid-cols-1 md:grid-cols-12 gap-8 md:gap-12 items-start py-8 border-b border-border/30 last:border-0 hover:bg-muted/5 rounded-2xl md:p-6 transition-colors">
                                
                                {/* Image (Left/Top) */}
                                <div class="col-span-12 md:col-span-5 order-last md:order-first">
                                    <a href={`/blog/${post.slug}/`} class="block aspect-[4/3] md:aspect-[3/2] overflow-hidden rounded-2xl relative">
                                        {post.featuredImage?.node?.sourceUrl ? (
                                            <img 
                                                src={post.featuredImage.node.sourceUrl} 
                                                alt={post.featuredImage.node.altText || post.title} 
                                                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                                            />
                                        ) : (
                                            <div class="w-full h-full bg-muted flex items-center justify-center text-muted-foreground">
                                                No Image
                                            </div>
                                        )}
                                        <div class="absolute inset-0 bg-primary/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                    </a>
                                </div>

                                {/* Content (Right) */}
                                <div class="col-span-12 md:col-span-7 flex flex-col justify-center space-y-4">
                                    <div class="flex items-center gap-3 text-sm text-primary font-medium">
                                        <div class="flex items-center gap-1 bg-primary/10 px-2 py-1 rounded-md">
                                            <Tag className="w-3 h-3" />
                                            <span>{post.categories?.nodes?.[0]?.name || 'Guide'}</span>
                                        </div>
                                        <span class="text-muted-foreground">â€¢</span>
                                        <div class="flex items-center gap-1 text-muted-foreground">
                                            <Calendar className="w-3 h-3" />
                                            <span>{formatDate(post.date)}</span>
                                        </div>
                                    </div>
                                    
                                    <h3 class="text-2xl md:text-3xl font-bold leading-tight group-hover:text-primary transition-colors">
                                        <a href={`/blog/${post.slug}/`}>
                                            {post.title}
                                        </a>
                                    </h3>

                                    <div class="text-muted-foreground text-base md:text-lg line-clamp-3 leading-relaxed" set:html={post.excerpt} />

                                    <div class="pt-4">
                                        <a href={`/blog/${post.slug}/`} class="inline-flex items-center gap-2 text-sm font-semibold text-foreground hover:text-primary transition-colors group/link">
                                            Read Article
                                            <ArrowUpRight className="w-4 h-4 transition-transform group-hover/link:translate-x-0.5 group-hover/link:-translate-y-0.5" />
                                        </a>
                                    </div>
                                </div>
                            </article>
                        ))}
                    </div>
                </section>
            )}
        </div>
	</main>
</Layout>
